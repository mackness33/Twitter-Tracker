<!DOCTYPE html>
<html>
  <head>
    <title>Twitter Tracker</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700' rel='stylesheet' type='text/css'>

    <style type="text/css">

		p {
   			margin-top: 1vw;
		}
		h1 {
   			text-align: center;
   			margin-top: 1vw;
   			margin-bottom: 1vw;
		   	color: #50ABF1;
   			font-size: 3vw;
   			font-family: Helvetica;
		}
		#input, #input2, #button {
   			height: 3vw;
   			width: 50%;
   			margin-top: 1vw;
   			margin-left: 25%;
   			margin-right: 25%;
   			text-align: center;
   			font-size: large;
   			border-radius: 5px;
   			border-color: rgb(0, 174, 255);
   			font-family: Arial, Helvetica, serif;
		}
		input[type="checkbox"]{
			margin-top: 1vw;
			margin-left: 25%;
		}
		#button {
		   	font-weight: bold;
   			background-color: blue;
   			color: orange;
		}
		#descrizione {
   			font-size: 0.6vw;
   			text-align: center;
		}

      	html, body {
        	margin: 0;
        	padding: 0;
        	height:100%;
        	font-family: open sans;
      		width: 100%;
      	}

      	#container-map, #ricerca, #word_cloud, #visualizzazione_tw{
		  	width:50%;
		  	height:50%;
		  	position: relative;
		  	float: left;
		  	overflow: auto;
		}

      	#map-canvas{
			width: 95%;
			height:95%;
			position:relative;
			z-index:10;
		}

	  	iframe{
			width: 95%;
			height: 95%;
		}

		.tweet_container{
			width: 95%;
			height: 70px;
			border: solid 2px #50ABF1;
			border-radius: 10px;
			margin: 10px;
			display: flex;
			align-items: center;
			scrollbar-width: none;  /* Firefox */
			overflow: scroll;
		}

		.tweet_userName{
			height: 100%;
			width: 250px;
			border: solid 2px #50ABF1;
			border-radius: 10px;
			margin-right: 20px;
			display: flex;
			align-items: center;
			justify-content: center;
			background-color: #50ABF1;
			color: white;
			scrollbar-width: none;  /* Firefox */
		}

		.tweet_text{
			height: 100%;
			color: #50ABF1;
			padding: 5px;
			overflow: scroll;
			scrollbar-width: none;  /* Firefox */
		}

	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<!--libreria mappa-->
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>

	<!--librerie wordcloud-->
	<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
	<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
	<script src="https://cdn.amcharts.com/lib/4/plugins/wordCloud.js"></script>
	<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
	<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.0/axios.min.js" integrity="sha512-DZqqY3PiOvTP9HkjIWgjO6ouCbq+dxqWoJZ/Q+zPYNHmlnI2dQnbJ5bxAHpAMw+LXRm4D72EIRXzvcHQtE8/VQ==" crossorigin="anonymous"></script>
    per visualizzare meglio il json
    <script>
		async function richiesta_dati(){
			const search = document.getElementById("input").value;
			const data = await axios.post("127.0.0.1:5000", {input: search});
			console.log(data);
		}
	-->
  <script src="//code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="https://cdn.socket.io/socket.io-3.0.1.min.js"></script>
  <script type="text/javascript" charset="utf-8">
      $(document).ready(function() {
        // start up the SocketIO connection to the server - the namespace 'test' is also included here if necessary
        var socket = io.connect('http://' + document.domain + ':' + location.port + '/base');

        // this is a callback that triggers when the "my response" event is emitted by the server.
        // socket.on('my response', function(msg) {
        //   $('#log').append('<p>Received: ' + msg.data + '</p>');
        // });

        socket.on('connection_done', function() {
          console.log('successfully connected to the SocketServer...');
          socket.emit('start_sample', {data: 'Starting sample stream'});
        });

        socket.on('tweet', function(msg) {
          console.log(msg);
          print_stream_tweets(msg)
        });

        socket.on('disconnect_client', function(msg) {
          socket.disconnect()
          console.log(msg);
        });

        $('form#foro').submit(function(event) {
            socket.emit('disconnect_server');
        });
      });
  </script>
	<script>
		/*gestione tweet raccolti*/
		function richiesta_dati(){
			$.ajax({
       	type: "POST",
       	url: "/base",
       	data: $("#foro").serialize(), // serializes the form's elements.
       	success: print_tweets(data)
     	});
		}

    function print_stream_tweets(response){
      let tweet = response.data
      let word_cloud_text = "";

      if (typeof tweet.entities !== "undefined"){
          if (typeof tweet.entities.hashtags !== "undefined"){
            tweet.entities.hashtags.forEach((hashtag, index) => {
              word_cloud_text = word_cloud_text + " " + hashtag.tag;
            });
        }
      }
      console.log('word_cloud_text: ', word_cloud_text);
      word_cloud(word_cloud_text);

      // visualizzazione tweet
      // TODO: set a maximum quantity of tweets to be visualize
      // TIP: use a Queue
      tweet_visualization(tweet)

      // maps
      var coordinate = [];
      if (typeof tweet.geo !== "undefined"){ //test mappa
        console.log('GEO: ', tweet.geo);
        if (typeof tweet.geo.coordinates!=="undefined"){
          console.log(typeof tweet.geo.coordinates.coordinates[0]);
          var long = tweet.geo.coordinates.coordinates[0];
          var lat = tweet.geo.coordinates.coordinates[1];
          var latlong = [lat, long];
          coordinate.push(latlong);
        }
      }

      initialize (coordinate);
    }

    function tweet_visualization(tweet){
      let node = document.getElementById("visualizzazione_tw")

      let container = document.createElement("div");
      container.setAttribute("id", "tweet" + tweet.id);
      container.setAttribute("class", "tweet_container");

      let username = document.createElement("div");
      username.setAttribute("id", "tweet" + tweet.id + "_userName");
      username.setAttribute("class", "tweet_userName");
      username.innerHTML = tweet.author_id;

      let text = document.createElement("div");
      text.setAttribute("id", "tweet" + tweet.id + "_text");
      text.setAttribute("class", "tweet_text");
      text.innerHTML = tweet.text;

      container.appendChild(username);
      container.appendChild(text);
      document.getElementById("visualizzazione_tw").appendChild(container);
    }

    function print_tweets(data){
      var dati = data.data
      //word cloud;
      var testo2 = "";
      var geo = true;   //test mappa

      for (a of dati){
        pk = 0;
        if (typeof a.entities!=="undefined"){
            if (typeof a.entities.hashtags!=="undefined"){
              while (typeof a.entities.hashtags[pk]!=="undefined"){
                testo2 = testo2 + " " + a.entities.hashtags[pk].tag;
              pk=pk+1;
            }
          }
        }
        if (typeof a.geo!=="undefined"){ //test mappa
          console.log(a.geo);
          geo = false;
        }
      }

      if (geo) { //test mappa
        console.log("zibibbo")
      }
      word_cloud(testo2);

      //controllo risposte
      console.log(dati);// show response from the server.

      //visualizzazione tweet
      var node = document.getElementById("visualizzazione_tw")
      while (node.hasChildNodes()) {
        node.removeChild(node.lastChild);
      }
      var index = 0
      dati.forEach(element => {
        var tmp = document.createElement("div");
        tmp.setAttribute("id", "tweet" + index);
        tmp.setAttribute("class", "tweet_container");
        var tmp2 = document.createElement("div");
        tmp2.setAttribute("id", "tweet" + index + "_userName");
        tmp2.setAttribute("class", "tweet_userName");
        tmp2.innerHTML = element.author_id;
        var tmp3 = document.createElement("div");
        tmp3.setAttribute("id", "tweet" + index + "_text");
        tmp3.setAttribute("class", "tweet_text");
        tmp3.innerHTML = element.text;
        tmp.appendChild(tmp2);
        tmp.appendChild(tmp3);
        document.getElementById("visualizzazione_tw").appendChild(tmp);
        index = index +1;
      });

      //colloca su mappa
      var coordinate = [];
      for (a of dati){
        if (typeof a.geo!=="undefined"){
          if (typeof a.geo.coordinates!=="undefined"){
            console.log(typeof a.geo.coordinates.coordinates[0]);
            var long = a.geo.coordinates.coordinates[0];
            var lat = a.geo.coordinates.coordinates[1];
            var latlong = [lat, long];
            coordinate.push(latlong);
          }
        }
      }

      initialize (coordinate);
    }

		/*mappa*/
		function initialize(coordinate) {
			/* Style of the map */
			var styles = [{
		      	stylers: [
		        	{ hue: "#00ffe6" },
		        	{ saturation: -20 }
		      	]
			},
			{
		      	featureType: "road",
		      	elementType: "geometry",
		      	stylers: [
		        	{ lightness: 100 },
		        	{ visibility: "simplified" }
		      	]
			},
			{
		      	featureType: "road",
		      	elementType: "labels",
		      	stylers: [
		        	{ visibility: "off" }
		      	]
			},
				{
		         	featureType: "poi",
		         	elementType: "labels",
		         	stylers: [
		           		{ visibility: "off" }
		         	]
		     	}
		  	];


		  	// Create a new StyledMapType object, passing it the array of styles,
		  	// as well as the name to be displayed on the map type control.
		  	var styledMap = new google.maps.StyledMapType(styles, {name: "Styled Map"});

		  	/* Lat. and Lon. of the center of the map */
		  	var myCenter = new google.maps.LatLng(44.302700, 11.21504);

		  	// Create a map object, and include the MapTypeId to add
		  	// to the map type control.
		  	var mapOptions = {
		    	zoom: 12, 				//zoom level
		    	center: myCenter, 		//center position
		    	scrollwheel: false, 	//zoom when scroll disable
		    	zoomControl: true, 		//show control zoom

		    	mapTypeControlOptions: {
		      		mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
		    	}

		  	};

		  	var map = new google.maps.Map(document.getElementById('map-canvas'),mapOptions);

		  	//Associate the styled map with the MapTypeId and set it to display.
		  	map.mapTypes.set('map_style', styledMap);
		  	map.setMapTypeId('map_style');

		  	for(a of coordinate){

		  		var myLatlng = new google.maps.LatLng(a[0], a[1]);
		  		var marker = new google.maps.Marker({
		      		position: myLatlng,
		      		map: map,
		  		});
		  	}
		}

		google.maps.event.addDomListener(window, 'load', initialize);

		//wordcloud

		function word_cloud(hashtags) {

			// Themes begin
			am4core.useTheme(am4themes_animated);
			// Themes end

			var chart = am4core.create("word_cloud", am4plugins_wordCloud.WordCloud);
			var series = chart.series.push(new am4plugins_wordCloud.WordCloudSeries());

			series.accuracy = 4;
			series.step = 15;
			series.rotationThreshold = 0.7;
			series.maxCount = 200;
			series.minWordLength = 2;
			series.labels.template.tooltipText = "{word}: {value}";
			series.fontFamily = "Courier New";
			series.maxFontSize = am4core.percent(30);

			series.text = hashtags;
		};

		</script>
  	</head>
  	<body>
		<h1>Twitter Tracker</h1>
		<div id="ricerca">
    		<form id="foro" method="post" target="tweet">
				<input id="input" type="text" name="ricerca" ><br>
				<input id="input2" type="text" name="numero_tw" ><br>
				<input type="checkbox" id="persona" name="persona">
				<label for="persona"> Username</label><br>
				<input type="checkbox" id="luogo" name="luogo">
				<label for="luogo"> Luogo</label><br>
				<input type="checkbox" id="area geografica" name="area geografica">
				<label for="area geografica"> Area geografica</label><br>
				<input type="checkbox" id="parola chiave" name="parola chiave">
				<label for="parola chiave"> Parola chiave</label><br>
				<input id="button" type="submit" onclick=richiesta_dati() value="Search">
    			<!--<input id="start" type="submit" onclick=richiesta_dati() value="Search" /> <!--aggiungere funzione ajax al posto di action-->
				<!--<input id="stop" type="submit" onclick=richiesta_dati() value="Search" /> <!--aggiungere funzione ajax al posto di action-->
				<!--onclick=richiesta_dati()-->
    		</form>
    		<p id="descrizione">
       			Per cercare: <br>
       			-una parola chiave scrivi la parola preceduta dal carattere #, <br>
       			-una zona scrivi il nome della zona preceduta dal carattere $, <br>
       			-gli spostamenti di una persona scrivi il nome utente di quella persona (compresa la @). <br>
    		</p>
		</div>
		<div id="visualizzazione_tw">
		</div>
  		<div id="container-map">
    		<div id="map-canvas"></div>
	  	</div>
		<div id="word_cloud">
		</div>
		<iframe name="tweet" style="display:none"></iframe>
  	</body>
</html>
